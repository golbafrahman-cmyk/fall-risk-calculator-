<!DOCTYPE html>

<html dir="rtl" lang="fa">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Fall Risk Calculator — Morse &amp; Humpty‑Dumpty</title>
<style>
  :root { --bg:#f7f7f7; --card:#fff; --accent:#007bff; --muted:#666; }
  html[lang="en"] { direction: ltr; }
  body { font-family: Tahoma, Arial, sans-serif; background:var(--bg); color:#222; padding:16px; }
  .container { max-width:900px; margin:0 auto; }
  .card { background:var(--card); border-radius:8px; padding:16px; box-shadow:0 1px 6px rgba(0,0,0,0.06); margin-bottom:16px; }
  h1,h2 { margin:6px 0 12px; }
  label { display:block; margin:8px 0 4px; }
  select,input[type="number"],input[type="text"] { width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .actions { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
  button { padding:10px 14px; border-radius:6px; border:0; background:var(--accent); color:white; cursor:pointer; }
  .result { margin-top:12px; padding:10px; border-radius:6px; background:#f1f8ff; }
  .intervention { margin-top:10px; padding:10px; border-radius:6px; background:#fff4e5; border:1px solid #ffd7a8; }
  small { color:var(--muted); }
  .topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:12px; }
  .lang-toggle { padding:6px 8px; border-radius:6px; border:1px solid #ccc; background:white; cursor:pointer; }
  footer { text-align:center; color:var(--muted); font-size:13px; margin-top:18px; }
  @media(max-width:760px){ .row { grid-template-columns:1fr; } .topbar { flex-direction:column; align-items:flex-start; } }
</style>
<link href="manifest.json" rel="manifest"/><meta content="#007bff" name="theme-color"/></head>
<body>
<div class="container">
<div class="topbar card" role="banner"><div class="logos"><img src="icon_1_192.png" style="height:60px;"/><img src="icon_2_192.png" style="height:60px;"/></div>
<div>
<h1 data-i18n="title_fa">ماشین‌حساب ریسک سقوط</h1>
<h1 data-i18n="title_en" style="display:none">Fall Risk Calculator</h1>
<small data-i18n="subtitle_fa">Morse برای بزرگسالان — Humpty‑Dumpty برای کودکان</small>
<small data-i18n="subtitle_en" style="display:none">Morse for adults — Humpty‑Dumpty for pediatrics</small>
</div>
<div>
<select aria-label="Language switcher" class="lang-toggle" id="lang">
<option value="fa">فارسی</option>
<option value="en">English</option>
</select>
</div>
</div>
<!-- Morse Card -->
<div class="card" id="morseCard">
<h2 data-i18n="morse_title_fa">بزرگسالان — مقیاس Morse</h2>
<h2 data-i18n="morse_title_en" style="display:none">Adults — Morse Scale</h2>
<small data-i18n="morse_desc_fa">۶ آیتم — امتیاز کلی ۰ تا ۱۲۵. آستانه‌ها: 0–24 کم، 25–44 متوسط، ≥45 بالا.</small>
<small data-i18n="morse_desc_en" style="display:none">6 items — score 0–125. Thresholds: 0–24 low, 25–44 moderate, ≥45 high.</small>
<label data-i18n="patient_label_fa">نام بیمار</label>
<label data-i18n="patient_label_en" style="display:none">Patient name</label>
<input id="patient_name_m" placeholder="" type="text"/>
<label data-i18n="morse_q1_fa">۱. سابقه سقوط در ۳ ماه گذشته</label>
<label data-i18n="morse_q1_en" style="display:none">1. History of falls in past 3 months</label>
<select id="morse_history">
<option data-i18n="opt_no_fa" value="0">خیر</option>
<option data-i18n="opt_yes_fa" value="25">بله (25)</option>
</select>
<label data-i18n="morse_q2_fa">۲. تشخیص ثانویه</label>
<label data-i18n="morse_q2_en" style="display:none">2. Secondary diagnosis</label>
<select id="morse_secondary">
<option value="0">خیر</option>
<option value="15">بله (15)</option>
</select>
<label data-i18n="morse_q3_fa">۳. وسایل کمکی در راه رفتن</label>
<label data-i18n="morse_q3_en" style="display:none">3. Ambulatory aid</label>
<select id="morse_ambulatory">
<option value="0">بدون / استراحت در تخت / کمک پرستار (0)</option>
<option value="15">چوب/عصا/واکر (15)</option>
<option value="30">نگه‌داشتن به اشیاء برای راه رفتن (30)</option>
</select>
<label data-i18n="morse_q4_fa">۴. داشتن IV یا خط داخل وریدی</label>
<label data-i18n="morse_q4_en" style="display:none">4. IV / IV lock</label>
<select id="morse_iv">
<option value="0">خیر</option>
<option value="20">بله (20)</option>
</select>
<label data-i18n="morse_q5_fa">۵. الگوی راه رفتن</label>
<label data-i18n="morse_q5_en" style="display:none">5. Gait</label>
<select id="morse_gait">
<option value="0">طبیعی (0)</option>
<option value="10">ضعف در راه رفتن (10)</option>
<option value="20">ناتوانی/راه رفتن بسیار مختل (20)</option>
</select>
<label data-i18n="morse_q6_fa">۶. وضعیت ذهنی</label>
<label data-i18n="morse_q6_en" style="display:none">6. Mental status</label>
<select id="morse_mental">
<option value="0">آگاه به محدودیت‌های خود (0)</option>
<option value="15">اغراق در توانایی / فراموش کردن محدودیت‌ها (15)</option>
</select>
<div class="actions">
<button id="morse_calc_btn" onclick="calcMorse()">محاسبه</button>
<button id="morse_save_btn" onclick="saveMorseCSV()">ذخیره CSV</button>
<button id="morse_copy_btn" onclick="copyMorse()">کپی نتیجه</button>
<button onclick="resetMorse()">پاک کردن فرم</button></div>
<div class="result" id="morse_result" style="display:none;"></div>
<div class="intervention" id="morse_intervention" style="display:none;"></div>
</div>
<!-- Humpty Card -->
<div class="card" id="humptyCard">
<h2 data-i18n="humpty_title_fa">کودکان — مقیاس Humpty‑Dumpty</h2>
<h2 data-i18n="humpty_title_en" style="display:none">Pediatrics — Humpty‑Dumpty</h2>
<small data-i18n="humpty_desc_fa">پارامترها: سن، جنس، تشخیص، شناخت، داروها، محیط. آستانه معمول ≥12 برای ریسک بالا.</small>
<small data-i18n="humpty_desc_en" style="display:none">Parameters: age, gender, diagnosis, cognition, medication, environment. Threshold ≥12 often indicates high risk.</small>
<label data-i18n="patient_label_fa2">نام کودک</label>
<label data-i18n="patient_label_en2" style="display:none">Child name</label>
<input id="patient_name_h" type="text"/>
<label data-i18n="h_age_fa">سن</label>
<label data-i18n="h_age_en" style="display:none">Age</label>
<select id="h_age">
<option value="4">کمتر از 3 سال (4)</option>
<option value="3">3 تا &lt;7 سال (3)</option>
<option value="2">7 تا &lt;13 سال (2)</option>
<option value="1">13 سال و بالاتر (1)</option>
</select>
<label data-i18n="h_gender_fa">جنس</label>
<label data-i18n="h_gender_en" style="display:none">Gender</label>
<select id="h_gender">
<option value="2">پسر (2)</option>
<option value="1">دختر (1)</option>
</select>
<label data-i18n="h_diag_fa">تشخیص</label>
<label data-i18n="h_diag_en" style="display:none">Diagnosis</label>
<select id="h_diagnosis">
<option value="4">تشخیص عصبی (4)</option>
<option value="3">اختلالات تنفسی/کاهش اکسیژن (3)</option>
<option value="2">روانپزشکی/رفتاری (2)</option>
<option value="1">سایر (1)</option>
</select>
<label data-i18n="h_cog_fa">شناخت / آگاهی از محدودیت‌ها</label>
<label data-i18n="h_cog_en" style="display:none">Cognition / awareness of limitations</label>
<select id="h_cognitive">
<option value="3">نمی‌داند محدودیت‌ها را (3)</option>
<option value="2">فراموش می‌کند (2)</option>
<option value="1">آگاه است (1)</option>
</select>
<label data-i18n="h_med_fa">داروها (تاثیر در هوشیاری)</label>
<label data-i18n="h_med_en" style="display:none">Medication (affecting consciousness)</label>
<select id="h_medication">
<option value="2">دارد (2)</option>
<option value="1">ندارد (1)</option>
</select>
<label data-i18n="h_env_fa">محیط / تجهیزات</label>
<label data-i18n="h_env_en" style="display:none">Environment / equipment</label>
<select id="h_environment">
<option value="3">پرخطر (3)</option>
<option value="1">کم‌خطر (1)</option>
</select>
<div class="actions">
<button id="humpty_calc_btn" onclick="calcHumpty()">محاسبه</button>
<button id="humpty_save_btn" onclick="saveHumptyCSV()">ذخیره CSV</button>
<button id="humpty_copy_btn" onclick="copyHumpty()">کپی نتیجه</button>
<button onclick="resetHumpty()">پاک کردن فرم</button></div>
<div class="result" id="humpty_result" style="display:none;"></div>
<div class="intervention" id="humpty_intervention" style="display:none;"></div>
</div>
<footer class="card">
<small data-i18n="footer_fa">این ابزار آموزشی است. قبل از استفاده کلینیکی، اعتبارسنجی و تایید پروتکل محل لازم است.</small>
<small data-i18n="footer_en" style="display:none">This tool is for educational purposes. Validate and follow local protocols before clinical use.</small>
<div>تهیه شده توسط واحد ایمنی بیمار بیمارستان هفده شهریور مشهد</div></footer>
</div>
<script>
(function(){
  // Language toggle
  const langSel = document.getElementById('lang');
  function setLang(l){
    document.documentElement.lang = l;
    document.documentElement.dir = (l === 'fa') ? 'rtl' : 'ltr';
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if(!key) return;
      if(l === 'fa' && key.endsWith('_fa')) el.style.display = '';
      else if(l === 'en' && key.endsWith('_en')) el.style.display = '';
      else el.style.display = 'none';
    });
  }
  setLang('fa');
  langSel.addEventListener('change', e => setLang(e.target.value));

  function downloadCSV(filename, rows) {
    const data = rows.map(r => r.map(field => '"'+String(field).replace(/"/g,'""')+'"').join(',')).join('\n');
    const blob = new Blob([data], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.style.display='none';
    document.body.appendChild(a); a.click(); setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 150);
  }

  // Morse
  window.calcMorse = function(){
    const name = document.getElementById('patient_name_m').value || '';
    const keys = ['morse_history','morse_secondary','morse_ambulatory','morse_iv','morse_gait','morse_mental'];
    let total = 0; keys.forEach(k => total += Number(document.getElementById(k).value || 0));
    let risk='';
    if(total >= 45) risk = (document.documentElement.lang==='fa') ? 'خطر بالا (High risk)' : 'High risk (≥45)';
    else if(total >= 25) risk = (document.documentElement.lang==='fa') ? 'خطر متوسط (Moderate risk)' : 'Moderate risk (25–44)';
    else risk = (document.documentElement.lang==='fa') ? 'خطر کم (Low risk)' : 'Low risk (0–24)';
    const resBox = document.getElementById('morse_result');
    resBox.innerHTML = `<strong>${(document.documentElement.lang==='fa')? 'امتیاز Morse' : 'Morse score'}:</strong> ${total} <br><strong>${(document.documentElement.lang==='fa')? 'تفسیر' : 'Interpretation'}:</strong> ${risk}`;
    resBox.style.display='block';

    const inter = document.getElementById('morse_intervention'); let interTxt = '';
    if(total >=45){
      interTxt = (document.documentElement.lang==='fa') ? '<strong>توصیه‌های مداخله‌ای (خطر بالا):</strong><ul><li>اعلام به تیم پرستاری و قرار دادن علامت هشدار، استفاده از کفش ضد لغزش، و اطمینان از نور کافی در اتاق.</li><li>استفاده از وسایل کمکی مناسب و آموزش بیمار.</li><li>استفاده از حفاظ‌های تخت، تنظیم ارتفاع، و تشکچه محافظ.</li><li>بازنگری داروها و اصلاح عوامل قابل تغییر.</li><li>افزایش نظارت (بازدید پرستار هر ۱–۲ ساعت).</li></ul>' : '<strong>Interventions (High risk):</strong><ul><li>Notify nursing team & place fall-risk sign.</li><li>Use appropriate assistive devices and patient education.</li><li>Use bed rails/low bed and protective padding.</li><li>Review medications and modifiable factors.</li><li>Increase observation (nurse checks every 1–2 hrs).</li></ul>';
    } else if(total >=25){
      interTxt = (document.documentElement.lang==='fa') ? '<strong>توصیه‌های مداخله‌ای (متوسط):</strong><ul><li>بازبینی روزانه و آموزش به بیمار/خانواده.</li><li>اطمینان از دسترسی آسان به زنگ پرستار.</li><li>حذف موانع محیطی.</li></ul>' : '<strong>Interventions (Moderate):</strong><ul><li>Daily reassessment and patient/family education.</li><li>Ensure easy access to call bell.</li><li>Remove environmental hazards.</li></ul>';
    } else {
      interTxt = (document.documentElement.lang==='fa') ? '<strong>اقدامات پیشگیرانه:</strong><ul><li>ادامه نظارت معمول و آموزش ایمنی.</li><li>کارهای پیشگیرانه و بررسی دوره‌ای.</li></ul>' : '<strong>Preventive measures:</strong><ul><li>Continue routine observation and safety education.</li><li>Periodic reassessment.</li></ul>';
    }
    inter.innerHTML = interTxt; inter.style.display='block';
    return {name, total, risk};
  };

  // Humpty
  window.calcHumpty = function(){
    const name = document.getElementById('patient_name_h').value || '';
    const ids = ['h_age','h_gender','h_diagnosis','h_cognitive','h_medication','h_environment'];
    let total = 0; ids.forEach(id => total += Number(document.getElementById(id).value || 0));
    let risk = total >= 12 ? ((document.documentElement.lang==='fa')? 'ریسک بالا (High risk)':'High risk (≥12)') : ((document.documentElement.lang==='fa')? 'ریسک کم/متوسط':'Low/Moderate risk');
    const box = document.getElementById('humpty_result');
    box.innerHTML = `<strong>${(document.documentElement.lang==='fa')? 'امتیاز Humpty‑Dumpty' : 'Humpty‑Dumpty score'}:</strong> ${total} <br><strong>${(document.documentElement.lang==='fa')? 'تفسیر' : 'Interpretation'}:</strong> ${risk}`;
    box.style.display='block';

    const inter = document.getElementById('humpty_intervention'); let interTxt='';
    if(total >= 12){
      interTxt = (document.documentElement.lang==='fa') ? '<strong>توصیه‌های مداخله‌ای (ریسک بالا):</strong><ul><li>افزایش نظارت کنار تخت و استفاده از حفاظ تخت مناسب.</li><li>اطلاع والدین/سرپرست، آموزش اقدامات ایمنی، و بررسی منظم محیط بازی یا اتاق کودک.</li><li>تنظیم ارتفاع تخت و ایمن‌سازی محیط.</li><li>بازنگری داروها و دوزها.</li></ul>' : '<strong>Interventions (High risk):</strong><ul><li>Increase bedside observation and use appropriate bed rails.</li><li>Inform caregivers and provide safety education.</li><li>Adjust bed height and secure environment.</li><li>Review medications and dosages.</li></ul>';
    } else {
      interTxt = (document.documentElement.lang==='fa') ? '<strong>اقدامات پیشگیرانه:</strong><ul><li>نظارت معمول و آموزش والدین.</li><li>ایمن‌سازی محیط.</li></ul>' : '<strong>Preventive measures:</strong><ul><li>Standard observation and caregiver education.</li><li>Secure the environment.</li></ul>';
    }
    inter.innerHTML = interTxt; inter.style.display='block';
    return {name, total, risk};
  };

  // Save CSV
  window.saveMorseCSV = function(){ const r = calcMorse(); const ts = new Date().toISOString(); const header = ['timestamp','scale','patient_name','score','interpretation']; const row = [ts, 'Morse', r.name, r.total, r.risk]; downloadCSV('morse_'+ts.replace(/[:.]/g,'-')+'.csv', [header, row]); };
  window.saveHumptyCSV = function(){ const r = calcHumpty(); const ts = new Date().toISOString(); const header = ['timestamp','scale','patient_name','score','interpretation']; const row = [ts, 'Humpty-Dumpty', r.name, r.total, r.risk]; downloadCSV('humpty_'+ts.replace(/[:.]/g,'-')+'.csv', [header, row]); };

  // Copy helpers
  window.copyMorse = function(){ const r = calcMorse(); const text = `Morse | ${r.name} | ${r.total} | ${r.risk}`; navigator.clipboard?.writeText(text).then(()=> alert((document.documentElement.lang==='fa')?'کپی شد':'Copied')); };
  window.copyHumpty = function(){ const r = calcHumpty(); const text = `Humpty | ${r.name} | ${r.total} | ${r.risk}`; navigator.clipboard?.writeText(text).then(()=> alert((document.documentElement.lang==='fa')?'کپی شد':'Copied')); };

  setTimeout(()=>{ document.getElementById('patient_name_m').placeholder = (document.documentElement.lang==='fa') ? 'مثلاً: علی رضایی' : 'e.g. John Smith'; document.getElementById('patient_name_h').placeholder = (document.documentElement.lang==='fa') ? 'مثلاً: سارا محمدی' : 'e.g. Sara Johnson'; }, 100);
})();
window.resetMorse = function(){
  document.getElementById('patient_name_m').value = '';
  ['morse_history','morse_secondary','morse_ambulatory','morse_iv','morse_gait','morse_mental'].forEach(id => document.getElementById(id).selectedIndex = 0);
  document.getElementById('morse_result').style.display='none';
  document.getElementById('morse_intervention').style.display='none';
};
window.resetHumpty = function(){
  document.getElementById('patient_name_h').value = '';
  ['h_age','h_gender','h_diagnosis','h_cognitive','h_medication','h_environment'].forEach(id => document.getElementById(id).selectedIndex = 0);
  document.getElementById('humpty_result').style.display='none';
  document.getElementById('humpty_intervention').style.display='none';
};
</script>
<script>if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js').catch(()=>{}); }</script></body>
</html>
